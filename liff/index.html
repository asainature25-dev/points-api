<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ポイント残高</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body style="font-family: sans-serif; padding: 16px;">
  <h2>ポイント残高</h2>
  <button id="checkoutBtn" style="margin:12px 0; padding:10px 14px; border-radius:10px;">
  月額9,900円で登録（決済へ）
</button>
  <div id="state">起動中...</div>
  <pre id="out" style="background:#f5f5f5;padding:12px;border-radius:8px;white-space:pre-wrap;"></pre>

 <script>
  const LIFF_ID = "2009265721-v5XUFK45";

  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();

      // 決済ボタン（修正版）
      document.getElementById("checkoutBtn").onclick = async () => {
        try {
          const res = await fetch("https://chanfana-openapi-template.asai-nature25-557.workers.dev/api/stripe/create-checkout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ line_user_id: profile.userId }),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.url) {
            alert("create-checkout error: " + JSON.stringify({ status: res.status, data }));
            return;
          }

          // LIFF内なら外部ブラウザで開く（Stripeはこれが安定）
          if (liff.isInClient()) {
            liff.openWindow({ url: data.url, external: true });
          } else {
            window.location.href = data.url;
          }
        } catch (e) {
          alert("create-checkout exception: " + String(e));
        }
      };

      // 残高表示
      document.getElementById("state").textContent = "取得中...";
      document.getElementById("out").textContent =
        "line_user_id: " + profile.userId + "\n" +
        "displayName: " + profile.displayName;

      const res2 = await fetch(
  `https://chanfana-openapi-template.asai-nature25-557.workers.dev/api/points/balance-line?line_user_id=${encodeURIComponent(profile.userId)}`
);
      const json2 = await res2.json();

      document.getElementById("state").textContent = "結果";
      document.getElementById("out").textContent += "\n\n" + JSON.stringify(json2, null, 2);
    } catch (e) {
      document.getElementById("state").textContent = "エラー";
      document.getElementById("out").textContent = String(e);
    }
  }

  main();
</script>
</body>
</html>