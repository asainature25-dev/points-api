<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ポイント残高</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body style="font-family: system-ui, sans-serif; padding: 16px;">
  <h2 style="margin:0 0 8px;">ポイント残高</h2>

  <button id="checkoutBtn" style="margin:12px 0; padding:10px 14px; border-radius:10px;">
    月額9,900円で登録（決済へ）
  </button>

  <div id="state" style="margin:8px 0;">起動中...</div>

  <pre id="out" style="background:#f5f5f5;padding:12px;border-radius:8px;white-space:pre-wrap;"></pre>

<script>
  // ======= 必ずあなたのLIFF ID =======
  const LIFF_ID = "2009265721-v5XUFK45";

  // ======= APIは全部 Worker に寄せる（ここ超重要） =======
  const API_BASE = "https://chanfana-openapi-template.asai-nature25-557.workers.dev";

  const $state = document.getElementById("state");
  const $out   = document.getElementById("out");
  const $btn   = document.getElementById("checkoutBtn");

  const show = (msg, obj) => {
    $state.textContent = msg;
    if (obj !== undefined) {
      $out.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }
  };

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }
    return { res, data };
  }

  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      show("取得中...", {
        line_user_id: profile.userId,
        displayName: profile.displayName
      });

      // ====== 決済ボタン ======
      $btn.onclick = async () => {
        try {
          show("決済URLを作成中...");

          const { res, data } = await fetchJson(`${API_BASE}/api/stripe/create-checkout`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ line_user_id: profile.userId }),
          });

          if (!res.ok || !data.url) {
            alert("create-checkout error: " + JSON.stringify({ status: res.status, data }));
            show("エラー", { status: res.status, data });
            return;
          }

          // Stripeは外部ブラウザで開くのが安定
          if (liff.isInClient()) {
            liff.openWindow({ url: data.url, external: true });
          } else {
            window.location.href = data.url;
          }
        } catch (e) {
          alert("create-checkout exception: " + String(e));
          show("エラー", String(e));
        }
      };

      // ====== 残高取得（Worker） ======
      const { res: resBal, data: bal } = await fetchJson(
        `${API_BASE}/api/points/balance-line?line_user_id=${encodeURIComponent(profile.userId)}`,
        { method: "GET" }
      );

      if (!resBal.ok) {
        show("残高取得エラー", { status: resBal.status, bal });
        return;
      }

      // 画面表示
      $state.textContent = "結果";
      $out.textContent =
        "line_user_id: " + profile.userId + "\n" +
        "displayName: " + profile.displayName + "\n\n" +
        JSON.stringify(bal, null, 2);

    } catch (e) {
      show("エラー", String(e));
    }
  }

  main();
</script>
</body>
</html>