<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ポイント残高</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body style="font-family: system-ui, sans-serif; padding: 16px;">
  <h2 style="margin:0 0 8px;">ポイント残高</h2>

  <button id="checkoutBtn" style="margin:12px 0; padding:10px 14px; border-radius:10px;">
    月額9,900円で登録（決済へ）
  </button>

  <div id="state" style="margin:8px 0;">起動中...</div>

  <pre id="out" style="background:#f5f5f5;padding:12px;border-radius:8px;white-space:pre-wrap;"></pre>

<script>
  // ======= LIFF ID =======
  const LIFF_ID = "2009265721-v5XUFK45";

  // ======= APIは Worker に寄せる =======
  const API_BASE = "https://chanfana-openapi-template.asai-nature25-557.workers.dev".replace(/\/+$/, "");

  const $state = document.getElementById("state");
  const $out   = document.getElementById("out");
  const $btn   = document.getElementById("checkoutBtn");

  // 事故防止：ログイン/初期化が終わるまで押せない
  $btn.disabled = true;
  $btn.style.opacity = "0.6";

  const show = (msg, obj) => {
    $state.textContent = msg;
    if (obj !== undefined) {
      $out.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }
  };

  async function fetchJson(url, options) {
    const res = await fetch(url, options);
    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch (_) { data = { raw: text }; }
    return { res, data };
  }

  async function main() {
    try {
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const profile = await liff.getProfile();

      // ログイン完了したのでボタン有効化
      $btn.disabled = false;
      $btn.style.opacity = "1";

      show("取得中...", {
        line_user_id: profile.userId,
        displayName: profile.displayName
      });

      // ====== 決済ボタン ======
      $btn.onclick = async () => {
        try {
          $btn.disabled = true;
          $btn.style.opacity = "0.6";
          show("決済URLを作成中...");

          const { res, data } = await fetchJson(`${API_BASE}/api/stripe/create-checkout`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ line_user_id: profile.userId }),
          });

          if (!res.ok || !data.url) {
            alert("create-checkout error: " + JSON.stringify({ status: res.status, data }));
            show("create-checkout エラー", { status: res.status, data });
            $btn.disabled = false;
            $btn.style.opacity = "1";
            return;
          }

          // Stripeは外部ブラウザで開くのが安定
          if (liff.isInClient()) {
            liff.openWindow({ url: data.url, external: true });
          } else {
            window.location.href = data.url;
          }
        } catch (e) {
          alert("create-checkout exception: " + String(e));
          show("create-checkout 例外", String(e));
          $btn.disabled = false;
          $btn.style.opacity = "1";
        }
      };

      // ====== 残高取得（Worker） ======
      const { res: resBal, data: bal } = await fetchJson(
        `${API_BASE}/api/points/balance-line?line_user_id=${encodeURIComponent(profile.userId)}`,
        { method: "GET" }
      );

      // 未連携は「エラー」じゃなく「案内」にする
      if (resBal.status === 404 && bal?.error === "member not linked") {
        show("未連携", {
          ok: false,
          error: "member not linked",
          message: "LINEユーザーが会員に紐付いていません。決済後 or 運営の紐付け処理が必要です。",
          line_user_id: profile.userId
        });
        return;
      }

      if (!resBal.ok) {
        show("残高取得エラー", { status: resBal.status, bal });
        return;
      }

      // ====== 表示 ======
      $state.textContent = "結果";
      $out.textContent =
        "line_user_id: " + profile.userId + "\n" +
        "displayName: " + profile.displayName + "\n\n" +
        JSON.stringify(bal, null, 2);

    } catch (e) {
      show("エラー", String(e));
    }
  }

  main();
</script>
</body>
</html>